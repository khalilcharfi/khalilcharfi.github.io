name: ðŸ§ª Test Deploy

on:
  workflow_dispatch:
    inputs:
      test_environment:
        description: 'Test environment'
        required: true
        default: 'staging'
        type: choice
        options: [staging, production]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "test-pages-${{ github.ref_name }}"
  cancel-in-progress: false

env:
  NODE_VERSION: '22'

jobs:
  test-deploy:
    name: ðŸ§ª Test Deployment
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.test_environment == 'production' && 'github-pages' || 'github-pages-staging' }}
    
    steps:
      - name: âš¡ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: âš¡ Install dependencies
        run: npm ci --prefer-offline --no-audit --no-fund --silent
      
      - name: âš¡ Build project
        run: npm run build:prod
        env:
          NODE_ENV: production
      
      - name: âš¡ Create test page
        run: |
          echo "<!DOCTYPE html>
          <html>
          <head>
            <title>Test Deploy - $(date)</title>
            <meta charset='utf-8'>
          </head>
          <body>
            <h1>ðŸš€ Test Deployment Successful!</h1>
            <p>Environment: ${{ inputs.test_environment }}</p>
            <p>Branch: ${{ github.ref_name }}</p>
            <p>Commit: ${{ github.sha }}</p>
            <p>Time: $(date -u)</p>
            <p>This is a test deployment to verify GitHub Pages setup.</p>
          </body>
          </html>" > dist/index.html
      
      - name: âš¡ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'
      
      - name: âš¡ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: âš¡ Verify deployment
        run: |
          echo "ðŸš€ Test deployment completed!"
          echo "Environment: ${{ inputs.test_environment }}"
          echo "URL: ${{ steps.deployment.outputs.page_url }}"
          echo "âœ… GitHub Pages deployment test successful!"
