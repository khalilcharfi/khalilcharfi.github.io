name: Deploy Built Project to Master Branch

on:
  push:
    branches: [ next ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout next branch
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3Ô∏è‚É£ Install dependencies including terser
      - name: Install dependencies
        run: |
          npm ci
          npm install --save-dev terser

      # 4Ô∏è‚É£ Create production .env (no NODE_ENV here)
      - name: Create production .env
        run: |
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY || '' }}" >> .env.production
          echo "VITE_ENABLE_CHATBOT=${{ secrets.VITE_ENABLE_CHATBOT || 'false' }}" >> .env.production
          echo "VITE_ENABLE_DYNAMIC_CONTENT=${{ secrets.VITE_ENABLE_DYNAMIC_CONTENT || 'false' }}" >> .env.production
          echo "VITE_SHOW_DEV_ELEMENTS=false" >> .env.production
          echo "VITE_SHOW_VISITOR_CONTROLS=false" >> .env.production
          echo "VITE_SHOW_PROFILE_INSIGHTS=false" >> .env.production
          echo "VITE_SHOW_TRANSLATION_DEBUG=false" >> .env.production
          echo "VITE_SHOW_DEBUG_INFO=false" >> .env.production

      # 5Ô∏è‚É£ Build project (Vite production mode via CLI)
      - name: Build project
        run: npm run build:prod

      # 6Ô∏è‚É£ Prepare deploy directory
      - name: Prepare deploy directory
        run: |
          mkdir deploy
          cp -r dist/* deploy/
          cp .env.production deploy/
          cp .env.example deploy/
          cp README.md deploy/
          cp package.json deploy/

      # 7Ô∏è‚É£ Discard local changes before switching branches
      - name: Discard local changes
        run: git reset --hard

      # 8Ô∏è‚É£ Checkout master branch
      - name: Checkout master branch
        run: |
          git fetch origin master
          git checkout master
          git pull origin master

      # 9Ô∏è‚É£ Clean master branch except .git
      - name: Clean master branch
        run: |
          find . -maxdepth 1 -not -name '.git' -not -name '.' -exec rm -rf {} +

      # üîü Copy deploy contents to root
      - name: Copy deploy files
        run: cp -r deploy/* .

      # 1Ô∏è‚É£1Ô∏è‚É£ Configure Git
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      # 1Ô∏è‚É£2Ô∏è‚É£ Commit and push
      - name: Commit and push
        run: |
          git add .
          git commit -m "Deploy built project from next branch - $(date)" || echo "No changes to commit"
          git push origin master

      # 1Ô∏è‚É£3Ô∏è‚É£ Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./